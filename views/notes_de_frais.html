<!DOCTYPE html>
<html lang="en">

<!-- Datatables -->
<link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
<link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
<link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
<link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
<link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
<link href="../stylesheets/monthpicker.css" rel="stylesheet" type="text/css">

<!-- page content -->
<!-- POP delete Ligne de Frais -->

<div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span
                                class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                        <div class="panel-title text-center"><i class="glyphicon glyphicon-trash"></i>&nbsp;Suppression
                            de Ligne de Frais
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-body">

                <div class="alert alert-danger"><span class="glyphicon glyphicon-warning-sign"></span> Vous etes sur le
                    point de supprimer definitivement cette Ligne de Frais !
                </div>

            </div>
            <div class="modal-footer ">
                <button type="button" class="btn btn-danger btn-ok" id="delete"><span class="glyphicon glyphicon-remove"
                                                                                      style="color : rgba(74, 3, 1, 0.6);"></span>&nbsp;Supprimer
                </button>
                <button type="button" class="btn btn-default" data-dismiss="modal"><span class=""></span>Annuler
                </button>
            </div>
        </div>
    </div>
</div>

<!-- POP delete Ligne de Frais -->







<!-- POPUP ADD N FRAIS  -->

<div class="modal fade" id="addForm" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content" style="width: 800px !important; ">
      <div class="modal-header">

        <div class="panel panel-default">
          <div class="panel-heading">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span
              class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
              <div class="panel-title text-center"><i class="glyphicon glyphicon-plus"></i>&nbsp;Ajouter une
                nouvelle Ligne 
              </div>
            </div>
          </div>


        </div>


        <!-- <form class="modal-body form-horizontal" role="form" > -->

        <form action="" class="modal-body form-horizontal" role="form" name="form-add-Ligne de Frais" id="form-add-ligne"
        enctype="multipart/form-data" method="POST">



        <div id="ligneDeFrais"> 

         <div class="item form-group">
          <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">Mission<span class="required">*</span>
          </label>
          <div class="col-md-6 col-sm-6 col-xs-12">
            <select id = "mission0" name = "mission0" class="form-control">
              
            </select>
          </div>
        </div>


        <div class="item form-group">
          <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">Typologie de Frais<span class="required">*</span>
          </label>
          <div class="col-md-6 col-sm-6 col-xs-12">
            <select id = "typologie0" name = "typologie0" class="form-control">
              <option value ="1">Logement</option>
              <option value ="2">Transport</option>
              <option value ="3">Nourriture</option>
              <option value ="3">Autre</option>
            </select>
          </div>
        </div>




        <!-- <div class="item form-group">
          <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">Somme  <span class="required">*</span>
          </label>
          <div class="col-md-6 col-sm-6 col-xs-12">
            <input id = "somm0" name = "somme0" class="form-control col-md-7 col-xs-12" data-validate-length-range="5" data-validate-words="1"  placeholder="En euros" required="required" type="text"> 
          </div>
        </div> -->


        <div class="item form-group">
          <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">Justificatif   
          </label>

          <div class="col-md-4 col-sm-6 col-xs-12 checkbox">
            <label>
              <input id="file0" name = "file0" type="file" data-role="magic-overlay" data-target="#pictureBtn" data-edit="insertImage">
            </label>
          </div>

          <div class="col-md-4 col-sm-6 col-xs-12 checkbox">

            <div class="item form-group">
              <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">Justificatif perdu:   
              </label>


              <div class="col-md-4 col-sm-6 col-xs-12 checkbox">
                <label>
                  <input type="checkbox" class="js-switch"  /> 
                </label>
              </div>

            </div>
          </div>

        </div>


      </div>









      <div id="inputs" >

      </div>





      <div id="ButtonPlus" class="item form-group">

        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">  Ajouter une lignes de Frais 
        </label>

        <div class="col-md-4 col-sm-6 col-xs-12 checkbox">

          <a id="amount" name="amount" onclick="addInput();" class="btn btn-app">
            <i class="fa fa-plus"></i> Ligne
          </a>


        </div>

      </div>










      <div class="ln_solid"></div>
      <div class="form-group">
        <div class="col-md-6 col-md-offset-3">
          <button type="submit" class="btn btn-primary">Annuler</button>
          <button type="submit" id="button1s" name="button1s" class="btn btn-success">
            Valider
          </button>
        </div>
      </div>



    </form>

  </div>
  <!-- /.modal-content -->
</div>
<!-- /.modal-dialog -->
</div>















<div class="">
  <div class="page-title">
    <div class="page-title">
      <div class="title_left">
        <h3>Notes de frais</h3>



        <div class="item form-group">
          <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">Du Mois: </label>

          <div class="input-prepend input-group col-md-6 col-sm-6 col-xs-12">
            <span class="add-on input-group-addon"><i class="glyphicon glyphicon-calendar fa fa-calendar"></i></span>
            <input type="text" style="width: 200px" name="moisNf" id="moisNf" onclick="calendarInit();" class="form-control" >
          </div>
        </div>







      </div>



      <div class="title_right">
        <div class="col-md-5 col-sm-5 col-xs-12 form-group pull-right top_search">
          <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">Statut: </label>
          <i><label class="control-label col-md-6 col-sm-6 col-xs-12" for="name">Brouillon </label></i>
        </div>
      </div>
    </div>

    <div class="clearfix"></div>


    <!-- N Frais Tableau -->
    <div class="row">
      <div class="col-md-12">
        <div class="x_panel">
          <div class="x_title">
            <h2> Lignes de la note de frais du mois de <b id="moisCourant"></b><small></small></h2>
            <ul class="nav navbar-right panel_toolbox">
              <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
              </li>
              <li class="dropdown">

                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>

              </li>
              <li><a class="close-link"><i class="fa fa-close"></i></a>
              </li>
            </ul>

            <div class="clearfix"></div>
          </div>
          <div class="x_content">

                <a onclick="afficherForm();" class="btn btn-app">
                      <i class="fa fa-plus"></i> Ajouter une ligne
                    </a>

            <table id="noteFrais" class="table table-striped table-bordered">

              <thead>
                <tr>
                  <th>Mission</th>
                  <th>Catégorie frais</th>
                  <th>Justificatif</th>
                  <th>Statut</th>
                  <th style="text-align: center">Operation</th>
                </tr>
              </thead>
              <tbody>

              </tbody>
            </table> 

          </div>
        </div>
      </div>
    </div>




  </div>




  <!-- /page content -->

  <!-- Datatables -->
  <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
  <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
  <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
  <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
  <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
  <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
  <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
  <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
  <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
  <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
  <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
  <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
  <script src="../vendors/jszip/dist/jszip.min.js"></script>
  <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
  <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
  <script src="../javascripts/monthpicker.min.js"></script>




  <script type="text/javascript">
    var nbr = 0 ;
    function addInput(){
      var inputs = $('#inputs')
      if(nbr ==0){
        inputs.empty();
        inputs.innerHTML = "";
      }
      nbr++;

    // var amount = $('#amount').val();
    
    // inputs.innerHTML = "";
    // for(i = 0; i < nbr; i++) {
      // inputs.append('<input type="text" class="control-label col-md-6 col-sm-12 col-xs-12 name="input[' + nbr + ']" /> ');
      inputs.append('  <div class="ln_solid"></div> <div class="item form-group">                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">Mission<span class="required">*</span>                </label>                <div class="col-md-6 col-sm-6 col-xs-12">                  <select id = "mission'+nbr+'" name = "mission'+nbr+'" class="form-control">                    <option>Mission1</option>                    <option>Mission2</option>                    <option>Mission3</option>                  </select>                </div>              </div><div class="item form-group">                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">Typologie de Frais<span class="required">*</span>                </label>                <div class="col-md-6 col-sm-6 col-xs-12">                  <select class="form-control" id = "typologie'+nbr+'" name = "typologie'+nbr+'">                    <option>Transport</option>                    <option>Restaurant</option>                    <option>Hotel</option>                  </select>                </div>              </div>              <div class="item form-group">                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">Descriptif  <span class="required">*</span>                </label>                <div class="col-md-6 col-sm-6 col-xs-12">                  <input id = "descriptif'+nbr+'"  class="form-control col-md-7 col-xs-12" data-validate-length-range="5" data-validate-words="1" name = "name'+nbr+'" placeholder="" required="required" type="text">                </div>              </div>              <div class="item form-group">                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">Somme  <span class="required">*</span>                </label>                <div class="col-md-6 col-sm-6 col-xs-12">                  <input id = "somme'+nbr+'" class="form-control col-md-7 col-xs-12" data-validate-length-range="5" data-validate-words="1" name = "somme'+nbr+'" placeholder="En euros" required="required" type="text">                 </div>              </div>              <div class="item form-group">                <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">Justificatif                   </label>                <div class="col-md-4 col-sm-6 col-xs-12 checkbox">                  <label>                    <input type="file" data-role="magic-overlay" data-target="#pictureBtn" data-edit="insertImage" id = "file'+nbr+'" name = "file'+nbr+'" >                  </label>                </div>                <div class="col-md-4 col-sm-6 col-xs-12 checkbox">                  <div class="item form-group">                    <label class="control-label col-md-3 col-sm-3 col-xs-12" for="name">Justificatif perdu:                       </label>                    <div class="col-md-4 col-sm-6 col-xs-12 checkbox">                      <label>                        <input type="checkbox" class="js-switch"  />                       </label>                    </div>                  </div>                </div>              </div>');
    // }
  }


  // Month Picker Proprietes




  var today = new Date();
  var mm = today.getMonth()+1; 
  var yyyy = today.getFullYear();

  if(mm<10) {
    mm='0'+mm
  } 
  today = mm+'/'+yyyy;

  console.log(today+"yoyo");


  function calendarInit(){

    $('#moisNf').Monthpicker({

      onSelect: function () {
        console.log($('#moisNf').val());
        $('#moisCourant').html($('#moisNf').val());

        var res = $('#moisNf').val().split("/");
        // console.log("1 = "+res[0]+"lll"+res[1]);
        loadTable(res[0], res[1]);
      }
    });

    $('#moisNf').Monthpicker('option', { maxValue: today });
  }




  $(document).ready(function(){



    var month ;

    switch (mm){
      case "01" :
      month = "Jan";
      break;
      case "02" :
      month = "Fev";
      break;
      case "03" :
      month = "Mar";
      break;
      case "04" :
      month = "Avr";
      break;
      case "05" :
      month = "Mai";
      break;
      case "06" :
      month = "Jun";
      break;
      case "07" :
      month = "Jul";
      break;
      case "08" :
      month = "Aou";
      break;
      case "09" :
      month = "Sep";
      break;
      case "10" :
      month = "Oct";
      break;
      case "11" :
      month = "Nov";
      break;
      case "12" :
      month = "Dec";
      break;
    }

    $('#moisCourant').html(mm+"/"+yyyy);

    $('#moisNf').val(month+" "+yyyy);
      loadTable(mm, yyyy);


    var handleDataTableButtons = function() {
      if ($("#noteFrais").length) {
        $("#noteFrais").DataTable({
          dom: "Bfrtip",
          buttons: [
          {
            text : "<span class='fa fa-plus'></span> Ajouter une ligne",
            action : function () {
              setTimeout(
                function () {
                  $('#addForm').modal({backdrop: 'static', keyboard: true})
                }, 500)
            }
          },
          ],
          responsive: true
        });
      }
    };

    TableManageButtons = function() {
      "use strict";
      return {
        init: function() {
          handleDataTableButtons();
        }
      };
    }();

    
 });
    // TableManageButtons.init();




 

function loadTable(mm, yyyy){

  console.log("month = "+mm+" year " +yyyy);

$('#noteFrais tbody').remove();
  var id_collabo ; 
  var etat_ligne_frais  ; 
  var categorie_frais ;
  var mission ;
  var taille_LF;
  var tabIdLf =new Array();


  $.ajax({
    url :"/name",
    type:'GET',
    dataType: 'json',
    data: {},
    async: true,
    success: function(doc){

      $(doc).each(function() {
        id_collabo = $(this)[0]["id"];


        $.ajax({
          url :"/getNDF",
          type:'GET',
          dataType: 'json',
           data: {id : id_collabo,
            mois: mm,
            annee: yyyy},
            async: true,
          success: function(doc){
            console.log("count ndf "+ doc.length);
            $(doc).each(function() {
               id_nf = $(this)[0]["id"];

               console.log("getNDF"+JSON.stringify($(this)));
               console.log("id note de frais "+id_nf);
              
              $.ajax({
                url :"/getLDF",
                type:'GET',
                dataType: 'json',
                data: {id : id_nf},
                async: true,
                success: function(doc2){
                  
                  
                  i=0 ; 
                  while (doc2.length > i)
                  {

                    // console.log("count ldf "+ doc2.length);
                    console.log("getLDF"+JSON.stringify(doc2[i]));
                    
                    idLF = doc2[i]["id"] ; 
                    idmission = doc2[i]["id_mission"] ; 
                    iDcategFrais = doc2[i]["id_categorie_frais"] ; 
                    justificatif = doc2[i]["justificatif"];
                    iDetatLDF = doc2[i]["id_etat_ligne_frais"];
                    var nomEtat ;
                    var categFrais ; 


                    switch(iDetatLDF){
                      case 1 :
                      nomEtat = "Brouillon";
                      break;
                      case 2 :
                      nomEtat = "Envoyé";
                      break;
                      case 3 :
                      nomEtat = "Invalide_CS";
                      break;
                      case 4 :
                      nomEtat = "Invalide_RH";
                      break;
                      case 5 :
                      nomEtat = "Valide_CS";
                      break;
                      case 6 :
                      nomEtat = "Valide_RH";
                      break;
                      case 7 :
                      nomEtat = "Valide_Dirigeant";
                      break;
                      case 8 :
                      nomEtat = "Invalide_Dirigeant";
                      break;
                      case 9 :
                      nomEtat = "Annulation_Envoyé";
                      break;
                      case 10 :
                      nomEtat = "Annulation_Invalide_CS";
                      break;
                      case 11 :
                      nomEtat = "Annulation_Valide_CS";
                      break;
                      case 12 :
                      nomEtat = "Annulation_Invalide_RH";
                      break;
                      case 13 :
                      nomEtat = "Annulation_Valide_RH";
                      break;

                    }
                    switch (iDcategFrais){
                      case 1 : 
                      categFrais = "Transport"; 
                      break;
                      case 2 : 
                      categFrais = "Logement"; 
                      break;
                      case 3 : 
                      categFrais = "Nourriture"; 
                      break;
                      case 4 : 
                      categFrais = "Autre"; 
                      break;

                    }

                    


                                


                        $.ajax({

                            type: "GET",
                            url: '/missions',
                            data: {id: idmission},
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            cache: false,
                            async: false,
                            success: function (data) {

                              $(data).each(function(){

                                var nom_mission = $(this)[0]["nom"];
                                

                                successCallback(nom_mission);



                              })

                            },
                        });







                            function successCallback(nom_mission){
                                // console.log("ouhouhouhouh "+JSON.stringify(data));
                                /*  Remplissage de  tableau  */



                               $.ajax({

                            type: "GET",
                            url: '/getCatLDF',
                            data: {id: idLF},
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            cache: false,
                            async: false,
                            success: function (data) {

                              $(data).each(function(){

                                var categ = $(this)[0]["nom"];
                                

                                console.log("idlf  "+idLF+" catg = "+categ)

                                  successCallback2(nom_mission, categ);

                              })

                            },
                        });
                             }


                              function successCallback2(nom_mission, categ){

                            $.ajax({

                            type: "GET",
                            url: '/getEtatLDF',
                            data: {id: iDetatLDF},
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            cache: false,
                            async: false,
                            success: function (data) {

                              $(data).each(function(){

                                var etatlf = $(this)[0]["nom"];
                                



                                  successCallback3(nom_mission, categ, etatlf);

                              })

                            },
                        });
                             }


                                function successCallback3(nom_mission, categ, etatlf){

                                    if(etatlf=="Invalide_CS" || etatlf=="Brouillon" || etatlf=="Invalide_RH") 
                                      a ="";
                                    else a= "disabled=\"disabled\"";
                                    var trHTML = '';
                                    trHTML += '<tr><td>' + nom_mission + '</td><td>' + categ + '</td><td>' + justificatif + '</td><td>' + etatlf + '</td><td align="center" valign="middle" >' +
                                    ' <button onclick= \'editer(\"'+nom_mission+'\",\"'+categ+'\"); \' '+a+'type="button " class="btn btn-round btn-info"><a style="color: black" title = "Editer la ligne"><i class="fa fa-pencil"></i> </a></button>  &nbsp;&nbsp;&nbsp;<button '+a+'type="button" onclick= "removeLF();" class="btn btn-round btn-danger"><a style="color: black" title = "Supprimer la ligne" ><i class=" fa fa-trash-o"></i></a> </button> ' 

                                    + '</td></tr>';

                                    $('#noteFrais').append(trHTML);

                            }



                   


                      i++;

                    }




}

});







})




}

});


})






}

});









             //Appel Ajax pour recuperer le profil
            $.ajax({
              url :"/name",
              type:'GET',
              dataType: 'json',
              data: {},

              success: function(doc){

                $(doc).each(function() {
                  id_collabo = $(this)[0]["id"];


                  //Appel Ajax pour recuper l'id des missions du collaborateur
                  $.ajax({

                    type: "GET",
                    url: '/getMissions',
                    data: {idCollabo: id_collabo},
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    cache: false,

                    success: function (data) {

                      $(data).each(function() {
                        var id_mission = $(this)[0]["id_mission"];

                        //Appel Ajax pour recuperer les details de la mission
                          $.ajax({

                            type: "GET",
                            url: '/missions',
                            data: {id: id_mission},
                            contentType: "application/json; charset=utf-8",
                            dataType: "json",
                            cache: false,

                            success: function (data) {

                              $(data).each(function(){


                                var nom_mission = $(this)[0]["nom"];

                                 var itemval = '<option value='+id_mission+'>'+nom_mission+'</option>';
                                // console.log( "nom mission ==> " + itemval);
                                $("#mission0").append(itemval);

                              })

                            },
                        });

                      })                    
                    },
                });

              })
              
            }

          });


}
 





function afficherForm () {
              setTimeout(
                function () {
                  $('#addForm').modal({backdrop: 'static', keyboard: true})
                }, 500)
            }








function afficherForm () {
              setTimeout(
                function () {
                  $('#addForm').modal({backdrop: 'static', keyboard: true})
                }, 500)
            }























   
         $('#form-add-ligne').submit(function() {
          console.log("submit");           

            id_mission_f = $("#mission0").val();
            id_categorie_f = $("#typologie0").val();

            
                  $.ajax({
                          url: '/insererLDF',
                          type: 'POST',
                          dataType: 'json',
                          async:false,
                          data: {
                             id_note_frais : "1" ,
                             id_categorie_frais : id_categorie_f ,
                             id_etat_ligne_frais : "1",
                             id_mission :id_mission_f,
                             justificatif : "nulll"
                          },
                          success: function(response) {
                            alert(JSON.stringify(response));
                              // console.log(response);
                          //   if (response.type == "CreerConge")
                          //   {
                          //      notifier("success","<span class='fa fa-check'> "+response.message,null);
                             
                          //     setTimeout(function() {
                          //            $("#pageInterne").load("conges.html");
                          //       }, 3000);  
                             
                            
                          // }
                      },
                          error: function(err){
                        alert(JSON.stringify(err));
                      } 
                });
                 
             
               
           
          });










 function removeLF() {

             setTimeout(
                function () {
                  $('#confirm-delete').modal({backdrop: 'static', keyboard: true})
                }, 500)
            }



 function editer(nommission, cat) {

            console.log(nommission+"ss"+cat);
             setTimeout(
                function () {
                  $('#addForm').modal({backdrop: 'static', keyboard: true})
                }, 500)
            }








</script>




</body>
</html>






